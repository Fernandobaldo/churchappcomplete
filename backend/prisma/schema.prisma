generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AuditLog {
  id          String      @id @default(cuid())
  action      AuditAction
  entityType  String
  entityId    String?
  userId      String
  userEmail   String
  userRole    String?
  description String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  adminUserId String?
  AdminUser   AdminUser?  @relation(fields: [adminUserId], references: [id])
  createdAt   DateTime    @default(now())

  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([adminUserId])
}

model Branch {
  id               String             @id @default(cuid())
  name             String
  churchId         String
  isMainBranch     Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  Church           Church             @relation(fields: [churchId], references: [id], onDelete: Cascade)
  Contribution     Contribution[]
  Devotional       Devotional[]
  Event            Event[]
  Member           Member[]
  Notice           Notice[]
  Transaction      Transaction[]
  ServiceSchedule  ServiceSchedule[]
  MemberInviteLink MemberInviteLink[]
}

model Church {
  id          String          @id @default(cuid())
  name        String
  logoUrl     String?
  avatarUrl   String?
  isActive    Boolean         @default(true)
  address     String?
  phone       String?
  email       String?
  website     String?
  socialMedia Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  Branch      Branch[]
  Positions   ChurchPosition[]
}

model Contribution {
  id                String                      @id @default(cuid())
  title             String
  description       String?
  goal              Float?
  endDate           DateTime?
  raised            Float?                       @default(0)
  isActive          Boolean                      @default(true)
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  branchId          String
  Branch            Branch                       @relation(fields: [branchId], references: [id])
  Transaction      Transaction[]
  PaymentMethods    ContributionPaymentMethod[]
}

model Devotional {
  id             String           @id @default(cuid())
  title          String
  content        String?
  branchId       String?
  createdAt      DateTime         @default(now())
  date           DateTime         @default(now())
  passage        String
  authorId       String
  updatedAt      DateTime         @updatedAt
  Member         Member           @relation(fields: [authorId], references: [id])
  Branch         Branch?          @relation(fields: [branchId], references: [id])
  DevotionalLike DevotionalLike[]
}

model DevotionalLike {
  id           String     @id @default(cuid())
  devotionalId String
  userId       String
  createdAt    DateTime   @default(now())
  Devotional   Devotional @relation(fields: [devotionalId], references: [id])
  Member       Member     @relation(fields: [userId], references: [id])

  @@unique([devotionalId, userId])
}

model Event {
  id             String    @id @default(cuid())
  title          String
  description    String?
  location       String
  branchId       String
  hasDonation    Boolean   @default(false)
  donationLink   String?
  donationReason String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  time           String
  startDate      DateTime
  endDate        DateTime?
  imageUrl       String?
  Branch         Branch    @relation(fields: [branchId], references: [id])
}

model Member {
  id             String            @id @default(cuid())
  name           String
  email          String            @unique
  role           Role              @default(MEMBER)
  branchId       String
  address        String?
  avatarUrl      String?
  birthDate      DateTime?
  phone          String?
  userId         String?           @unique
  inviteLinkId   String?
  positionId     String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  Devotional     Devotional[]
  DevotionalLike DevotionalLike[]
  Branch         Branch            @relation(fields: [branchId], references: [id])
  User           User?             @relation(fields: [userId], references: [id])
  Permission     Permission[]
  InviteLink     MemberInviteLink? @relation(fields: [inviteLinkId], references: [id])
  Position       ChurchPosition?   @relation(fields: [positionId], references: [id])
}

model Notice {
  id        String   @id @default(cuid())
  title     String
  message   String
  branchId  String
  viewedBy  String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Branch    Branch   @relation(fields: [branchId], references: [id])
}

model Permission {
  id       String @id @default(cuid())
  memberId String
  type     String
  Member   Member @relation(fields: [memberId], references: [id])

  @@unique([type, memberId])
}

model Plan {
  id               String         @id @default(cuid())
  name             String         @unique
  price            Float
  features         String[]
  maxBranches      Int?
  maxMembers       Int?
  isActive         Boolean        @default(true)
  gatewayProvider  String?
  gatewayProductId String?
  gatewayPriceId   String?
  billingInterval  String         @default("month")
  syncStatus       String         @default("pending")
  Subscription     Subscription[]
}

model Subscription {
  id                   String            @id @default(cuid())
  userId               String
  planId               String
  status               SubscriptionStatus @default(pending)
  startedAt            DateTime          @default(now())
  endsAt               DateTime?
  gatewayProvider      String?
  gatewaySubscriptionId String?
  gatewayCustomerId    String?
  paymentMethodId      String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean           @default(false)
  canceledAt           DateTime?
  trialEnd             DateTime?
  Plan                 Plan              @relation(fields: [planId], references: [id])
  User                 User              @relation(fields: [userId], references: [id])
  PaymentHistory       PaymentHistory[]

  @@index([planId])
  @@index([userId])
  @@index([gatewaySubscriptionId])
  @@index([gatewayCustomerId])
  @@index([status])
}

model Transaction {
  id                 String          @id @default(cuid())
  title              String?
  amount             Float
  type               TransactionType
  category           String?
  entryType          EntryType?
  exitType           ExitType?
  exitTypeOther      String?
  tithePayerMemberId String?
  tithePayerName     String?
  isTithePayerMember Boolean?
  contributionId    String?
  createdBy          String?
  branchId           String
  date               DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  Branch             Branch          @relation(fields: [branchId], references: [id])
  Contribution       Contribution?   @relation(fields: [contributionId], references: [id])
  CreatedByUser      User?           @relation(fields: [createdBy], references: [id])
}

model ServiceSchedule {
  id                  String   @id @default(cuid())
  branchId            String
  dayOfWeek           Int // 0-6, onde 0 = Domingo
  time                String // formato HH:mm
  title               String
  description         String?
  location            String?
  isDefault           Boolean  @default(false)
  autoCreateEvents    Boolean  @default(false)
  autoCreateDaysAhead Int? // quantos dias à frente criar eventos, padrão: 90
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  Branch              Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([dayOfWeek])
}

model AdminUser {
  id           String      @id @default(cuid())
  name         String
  email        String      @unique
  passwordHash String
  adminRole    AdminRole   @default(SUPPORT)
  isActive     Boolean     @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  AuditLog     AuditLog[]
}

model User {
  id           String         @id @default(cuid())
  firstName    String         // Primeiro nome (obrigatório)
  lastName     String         // Sobrenome (obrigatório)
  email        String         @unique
  password     String
  phone        String?        // Telefone (opcional por enquanto, mas recomendado)
  document     String?        // CPF/CNPJ (opcional por enquanto, mas recomendado)
  isBlocked    Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Member       Member?
  Subscription Subscription[]
  Transactions Transaction[]
}

model MemberInviteLink {
  id          String    @id @default(cuid())
  token       String    @unique
  branchId    String
  createdBy   String
  maxUses     Int?
  currentUses Int       @default(0)
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Branch      Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  Member      Member[]

  @@index([token])
  @@index([branchId])
  @@index([isActive])
}

model ChurchPosition {
  id        String   @id @default(cuid())
  name      String
  churchId  String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  Members   Member[]

  @@index([churchId])
}

model ContributionPaymentMethod {
  id             String            @id @default(cuid())
  contributionId String
  type           PaymentMethodType
  data           Json // Campos específicos por tipo: PIX (chave), CONTA_BR (banco, agencia, conta, tipo), IBAN (iban, banco, nome)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  Contribution   Contribution      @relation(fields: [contributionId], references: [id], onDelete: Cascade)

  @@index([contributionId])
}

model PaymentHistory {
  id                String       @id @default(cuid())
  subscriptionId    String
  amount            Decimal      @db.Decimal(10, 2)
  currency          String       @default("BRL")
  status            String
  gatewayPaymentId  String?
  gatewayProvider   String?
  paidAt            DateTime?
  createdAt         DateTime     @default(now())
  Subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([gatewayPaymentId])
  @@index([status])
}

model WebhookEvent {
  id              String   @id @default(cuid())
  gatewayProvider String
  gatewayEventId  String
  eventType       String
  processed       Boolean  @default(false)
  processedAt     DateTime?
  payload         Json?
  createdAt       DateTime @default(now())

  @@unique([gatewayProvider, gatewayEventId])
  @@index([gatewayProvider])
  @@index([gatewayEventId])
  @@index([processed])
}

enum AuditAction {
  MEMBER_CREATED
  MEMBER_UPDATED
  MEMBER_DELETED
  MEMBER_ROLE_CHANGED
  MEMBER_PERMISSIONS_CHANGED
  BRANCH_CREATED
  BRANCH_UPDATED
  BRANCH_DELETED
  CHURCH_CREATED
  CHURCH_UPDATED
  CHURCH_DELETED
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  LOGIN
  LOGOUT
  PLAN_LIMIT_EXCEEDED
  UNAUTHORIZED_ACCESS_ATTEMPT
  SERVICE_SCHEDULE_CREATED
  SERVICE_SCHEDULE_UPDATED
  SERVICE_SCHEDULE_DELETED
  EVENTS_DELETED_FROM_SCHEDULE
  MEMBER_REGISTRATION_ATTEMPT
  INVITE_LINK_CREATED
  INVITE_LINK_DEACTIVATED
  ADMIN_LOGIN
  ADMIN_LOGOUT
  USER_BLOCKED
  USER_UNBLOCKED
  CHURCH_SUSPENDED
  CHURCH_REACTIVATED
  PLAN_CHANGED
  SUBSCRIPTION_CHANGED
  IMPERSONATE_USER
  IMPERSONATE_CHURCH_OWNER
  PASSWORD_RESET_SENT
  ADMIN_CONFIG_UPDATED
  PLAN_SYNCED_TO_GATEWAY
  PLAN_SYNC_ERROR
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  SUBSCRIPTION_RESUMED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  WEBHOOK_RECEIVED
  WEBHOOK_PROCESSED
  WEBHOOK_ERROR
}

enum PaymentMethodType {
  PIX
  CONTA_BR
  IBAN
}

enum Role {
  MEMBER
  COORDINATOR
  ADMINFILIAL
  ADMINGERAL
}

enum TransactionType {
  ENTRY
  EXIT
}

enum EntryType {
  OFERTA
  DIZIMO
  CONTRIBUICAO
}

enum ExitType {
  ALUGUEL
  ENERGIA
  AGUA
  INTERNET
  OUTROS
}

enum AdminRole {
  SUPERADMIN
  SUPPORT
  FINANCE
}

enum SubscriptionStatus {
  pending
  active
  past_due
  canceled
  unpaid
  trialing
}